---
title: "Fall Indicator"
author: "Matt Dzaugis"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    toc_float:
        collapsed: FALSE
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(patchwork)
library(factoextra)
library(gmRi)
# Set theme  
theme_set(theme_bw())

season <- c(9,10,11)
```


`r use_gmri_style_rmd(css_file = "gmri_rmarkdown.css")`

## Developing Indicators of Habitat and Ecosystem Change in the Gulf of Maine

### Study area

The focus area for this project is coastal Maine, extending from the coast to the eastern boundary of the NOAA statistical areas 511, 512, 513. 

```{r study area, fig.width=4, fig.cap="Study region. NOAA statistical areas are indicated as colored polygons. Maine coastal current study region indicated by the black outlined open polygon"}

usStates <- rnaturalearth::ne_states("united states of america", returnclass = "sf")
ne_us <- usStates %>% filter(name == "Maine")
statarea <- sf::st_read(paste0(gmRi::shared.path(group = "Res_Data", folder = "Shapefiles/Statistical_Areas"), "Statistical_Areas_2010_withnames.shp"), quiet = TRUE) %>% 
  filter(Id %in% c(511, 512, 513)) %>% 
  mutate(Id = as.factor(Id))
statarea_sf <- sf::st_simplify(statarea, dTolerance = .05)
mcc_turnoff_sf <- sf::st_read(here::here("Data/Shapefiles/MCC_turnoff/MCC_turnoff.shp"), quiet = TRUE)

ggplot() +  
  geom_sf(data = statarea_sf, aes(fill = Id)) + 
  geom_sf(data= ne_us, fill = "grey") +
  geom_sf(data = mcc_turnoff_sf, fill = "transparent", color = "black") +
  scale_fill_discrete(name = "Stat area") +
  theme(panel.background = element_blank(), 
        panel.grid = element_blank(), 
        axis.title = element_blank(),
        axis.ticks = element_blank())
```



### Indicators {.tabset}

The following indicators are used in this report

* Surface and bottom temperature (FVCOM)
* Surface and bottom salinity (FVCOM)
* Maine Coastal Current Index (FVCOM)
* Species-based lobster predator index (NOAA Trawl Survey)


```{r read_data}
# Indicators
FVCOM <- read_csv(here::here("Indicators/FVCOM_stat_area_temps.csv")) %>% 
  mutate(Year = Year -1)

sal <- read_csv(here::here("Indicators/FVCOM_stat_area_sal.csv")) %>% 
  mutate(Year = Year -1)

maineCC <- read_csv(here::here("Indicators/mcc_pca_pc1_2.csv")) %>% 
  rename("Year" = yr, "Month" = mon) %>% 
  mutate(Year = Year -1)

species_index <- read_rds(here::here("Indicators/nmfs_trawl_lobster_predator_indices.rdata")) %>% 
  rename("Year" = year) %>% 
  mutate(Year = Year -1)

mcc_turnoff_subset <- read_csv(here::here("Indicators/mcc_turnoff_subset.csv")) %>% 
  mutate(Year = Year -1)

cprData <- read_csv(here::here("Indicators/cpr_focal_pca_timeseries_period_1961-20017.csv")) %>% 
  mutate(`First Mode` = `First Mode`*-1) %>%
  rename("Year" = year,
         "FirstMode" = `First Mode`,
         "SecondMode" = `Second Mode`) %>% 
  select(Year, FirstMode, SecondMode) %>% 
  mutate(Year = Year -1)
  
```

#### Temperature

Source: FVCOM NECOFS Monthly Means [Thredds Link](http://www.smast.umassd.edu:8080/thredds/catalog/models/fvcom/NECOFS/Archive/Seaplan_33_Hindcast_v1/monthly_mean/catalog.html)
Methods: 
* Surface and bottom layer (1 m above bathymetry)
* Regridded to regular 0.1 deg grid
* Averaged over NOAA statistical area


```{r multivariate_calc}

yrFVCOM <- FVCOM %>% 
  filter(Month %in% season) %>% 
  group_by(Year, stat_area) %>% 
  summarise(sur_temp = mean(sur_temp),
            bot_temp = mean(bot_temp), .groups="drop") %>% 
  mutate(stat_area = as.factor(stat_area))

tPlot1 <- yrFVCOM %>% 
  ggplot() +
  geom_line(aes(Year, sur_temp, col = stat_area)) + 
  theme_bw() +
  labs(y = "SST (deg C)")

tPlot2 <- yrFVCOM %>% 
  ggplot() +
  geom_line(aes(Year, bot_temp, col = stat_area)) + 
  theme_bw() +
  labs(y = "Bottom T (deg C)")

tPlot1/tPlot2
```


#### Salinity

Source: FVCOM NECOFS Monthly Means [Thredds Link](http://www.smast.umassd.edu:8080/thredds/catalog/models/fvcom/NECOFS/Archive/Seaplan_33_Hindcast_v1/monthly_mean/catalog.html)
Methods: 
* Surface and bottom layer (1 m above bathymetry)
* Regridded to regular 0.1 deg grid
* Averaged over NOAA statistical area for each year


```{r salinity}

yrSal <- sal %>% 
  filter(Month %in% season) %>% 
  group_by(Year, stat_area) %>% 
  summarise(sur_sal = mean(sur_sal),
            bot_sal = mean(bot_sal)) %>% 
  mutate(stat_area = as.factor(stat_area))

sPlot1 <- yrSal %>% 
  ggplot() +
  geom_line(aes(Year, sur_sal, col = stat_area)) + 
  theme_bw() +
  labs(y = "SSS (deg C)")

sPlot2 <- yrSal %>% 
  ggplot() +
  geom_line(aes(Year, bot_sal, col = stat_area)) + 
  theme_bw() +
  labs(y = "Bottom S (deg C)")

sPlot1/sPlot2
```

#### Maine Coastal Current Index

Source: FVCOM NECOFS Monthly Means [Thredds Link](http://www.smast.umassd.edu:8080/thredds/catalog/models/fvcom/NECOFS/Archive/Seaplan_33_Hindcast_v1/monthly_mean/catalog.html)
Methods: 
* Surface layer
* Crop to Maine Coastal Current interest area
* Regridded to regular 0.1 deg grid
* Averaged over NOAA statistical area for each year
* See MCC_index_report.Rmd for details


```{r MCC}
yrMCC <- maineCC %>% 
  filter(Month %in% season) %>% 
  group_by(Year) %>% 
  summarise(MCCPC1 = mean(PC1))

MCCPC_plot <- yrMCC %>% 
  mutate(c = ifelse(MCCPC1 > 0, 1, 2)) %>% 
  ggplot() + geom_col(aes(x = Year, y = MCCPC1, fill = as.factor(c))) + theme_bw() + theme(legend.position = "none") + labs(x = "Year", y = "Maine Coastal Current PC1")

MCCPC_maps <- mcc_turnoff_subset %>% 
  mutate(Year = lubridate::year(as.Date(Date)),
         Month = lubridate::month(as.Date(Date))) %>% 
  filter(Year %in% c(1982, 1992, 1995, 2001, 2012, 2014),
         Month %in% c(5,6,7,8)) %>% 
  group_by(Year, lat, lon) %>% 
  summarise(u = mean(u),
            v = mean(v), .groups = "drop") %>% 
  mutate(vel = sqrt(u^2+v^2), 
         PC = if_else(Year == 2010, "negative PC1", if_else(Year ==2013, "positive PC1", "neutral PC1"))) %>% 
  ggplot() + geom_sf(data= ne_us, fill = "grey") + 
  geom_segment(aes(x = lon, y = lat, xend=lon+u, yend=lat+v, color = vel), 
               arrow = arrow(angle = 10, length = unit(0.05, "inches"), type = "closed")) + 
  scale_color_viridis_c() + theme_bw() + 
  coord_sf(datum = "+proj=longlat +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0") + 
  facet_wrap(~Year, nrow = 1)+ 
  theme(panel.background = element_blank(), panel.grid = element_blank(), 
        axis.title = element_blank(), axis.text = element_blank(),
        axis.ticks = element_blank())

MCCPC_plot / MCCPC_maps
```

#### Species Based Predator Index

Source: NOAA NE Fisheries Trawl Survey
Methods: 
* Filtered to 15 lobster predators (ASMFC 2020)
* Cropped to NOAA stat areas 511, 512, 513
* Stratum abundance: abundance per trawl summed over stat area
* Stratified abundance: abundance / km2 multiplied by the area of the strata


```{r pred_index}
yrSpecies_index <- 
  species_index %>% 
  filter(season == "Spring",
         `stratum id` != 'Strata 511-513') %>% 
  dplyr::select(Year, `stratum id`, "predators" = `stratified abundance`)

yrSpecies_index %>% 
  ggplot() +
  geom_line(aes(Year, predators, color = `stratum id` )) + theme_bw()

```


#### CPR data

Source: Continuous Plankton Recording

```{r cprData}
cprData %>% 
  ggplot() +
  geom_line(aes(Year, FirstMode)) +
  geom_line(aes(Year, SecondMode), color = "red") + theme_bw()

```



```{r multivariate analysis}

allIndex <- left_join(yrFVCOM, yrSal, by = c("Year", "stat_area")) %>% 
  left_join(yrMCC, by = c("Year" = "Year")) %>% 
  left_join(yrSpecies_index, by = c("Year" = "Year",
                                    "stat_area" = "stratum id")) %>% 
  left_join(cprData, by = "Year") %>% 
  na.omit()

```

### Indicators PCA{.tabset}

Data: SST, BT, SSS, BS, MCC, Predator Index
Method: Principal components analysis 
Years: 1990-2016

#### PCA Summary

```{r PCA_summary}

# PCA by stat area
indicator_pca <- allIndex %>% 
  nest(data = c(-stat_area, -Year),
       Year = Year) %>% 
  mutate(pca = map(data, ~prcomp(.x, scale. = TRUE, center = TRUE)),
         pca_index = map(pca, ~tibble("PC1" = .x$x[,1],
                                      "PC2" = .x$x[,2],
                                      "PC3" = .x$x[,3])))

index_pca <- indicator_pca %>% 
  unnest(c(pca_index, Year, data))

PCA511 <- data.frame(summary(indicator_pca$pca[[1]])$importance) %>% 
  rownames_to_column("Result") %>%  mutate(stat_area = "511")
PCA512 <- data.frame(summary(indicator_pca$pca[[2]])$importance) %>% 
  rownames_to_column("Result") %>%  mutate(stat_area = "512")
PCA513 <- data.frame(summary(indicator_pca$pca[[3]])$importance) %>% 
  rownames_to_column("Result") %>%  mutate(stat_area = "513")

PCA_table <- bind_rows(PCA511,PCA512,PCA513)

knitr::kable(PCA_table)
```

#### Scree Plots

```{r screeplots}
scree1 <- fviz_eig(indicator_pca$pca[[1]], ylab = "% variance explained") + scale_y_continuous(limits = c(0,60))
scree2 <- fviz_eig(indicator_pca$pca[[2]], ylab = "% variance explained") + scale_y_continuous(limits = c(0,60))
scree3 <- fviz_eig(indicator_pca$pca[[3]], ylab = "% variance explained") + scale_y_continuous(limits = c(0,60))

scree1 / scree2 / scree3
```


#### PC time series


```{r pcaTimeSeries}

PC1plot <- index_pca %>% 
  ggplot() + 
  geom_line(aes(Year, PC1, color = stat_area))

PC2plot <- index_pca %>% 
  ggplot() + 
  geom_line(aes(Year, PC2, color = stat_area))

PC3plot <- index_pca %>% 
  ggplot() + 
  geom_line(aes(Year, PC3, color = stat_area))

PC1plot / PC2plot / PC3plot
```


#### Loadings plot

```{r loadings, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Figure 4. Loadings of the variables"}

loadings1 <- fviz_pca_var(indicator_pca$pca[[1]],
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE) + labs(title = "Stat Area 511") +
  theme(legend.position = "none")

loadings2 <- fviz_pca_var(indicator_pca$pca[[2]],
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE) + labs(title = "Stat Area 512") +
  theme(legend.position = "none")

loadings3 <- fviz_pca_var(indicator_pca$pca[[3]],
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE) + labs(title = "Stat Area 513")

PC1loadings511 <- data.frame(indicator_pca$pca[[1]]$rotation) %>% 
  mutate(stat_area = "511") %>% 
  rownames_to_column("Indicator")
PC1loadings512 <- data.frame(indicator_pca$pca[[2]]$rotation) %>% 
  mutate(stat_area = "512") %>% 
  rownames_to_column("Indicator")
PC1loadings513 <- data.frame(indicator_pca$pca[[3]]$rotation) %>% 
  mutate(stat_area = "513",
         PC1 = PC1*-1) %>% 
  rownames_to_column("Indicator")

PC1loadings <- bind_rows(PC1loadings511, PC1loadings512, PC1loadings513)

loadings1 + loadings2 + loadings3

```

#### Global PCA

```{r global_pca}
# Global PCA

globalPCA <- allIndex %>% 
  group_by(Year) %>% 
  pivot_wider(names_from = stat_area,
              values_from = c(sur_temp, bot_temp, sur_sal, bot_sal, MCCPC1, predators)) %>% 
  nest(data = c(-Year),
       Year = Year) %>% 
  mutate(pca = map(data, ~prcomp(.x, scale. = TRUE, center = TRUE)),
         pca_index = map(pca, ~tibble("PC1" = .x$x[,1],
                                      "PC2" = .x$x[,2],
                                      "PC3" = .x$x[,3])))

index_globalPCA <- globalPCA %>% 
  unnest(c(pca_index, Year, data))

globalPCA_table <- data.frame(summary(globalPCA$pca[[1]])$importance) %>% 
  rownames_to_column("Result")

knitr::kable(globalPCA_table)


# GlobaPCA

fviz_pca_var(globalPCA$pca[[1]],
             col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE) + labs(title = "global PCA") +
  theme(legend.position = "none")
```


#### Chronolgical cluster

```{r indicators_cluster}

allIndex_ca <- allIndex %>% 
  group_by(Year) %>% 
  pivot_wider(names_from = stat_area,
              values_from = c(sur_temp, bot_temp, sur_sal, bot_sal, MCCPC1, predators)) %>% 
  column_to_rownames("Year")

allIndex_ca <- scale(allIndex_ca)

# determine number of clusters
wss <- (nrow(allIndex_ca)-1)*sum(apply(allIndex_ca,2,var)) # get sum of squares

for (i in 2:12) wss[i] <- sum(kmeans(allIndex_ca,
   centers=i)$withinss)

# look for break in plot like a scree plot
kmeans_scree <- ggplot() + 
  geom_line(aes(x = c(1:12), y = wss)) +
  labs(x = "Number of Clusters",
  y ="Within groups sum of squares")

# K-Means Cluster Analysis
fit <- kmeans(allIndex_ca, 3) # 4 cluster solution

# get cluster means
#aggregate(allIndex_ca,by=list(fit$cluster),FUN=mean)

# append cluster assignment
lobData_cluster <- data.frame(allIndex_ca, fit$cluster)

# Cluster Plot against 1st 2 principal components

# vary parameters for most readable graph
indicators_cluster <- cluster::clusplot(allIndex_ca, fit$cluster, color=TRUE, shade=TRUE,
   labels=2, lines=0)

indicators_cluster
```


#### Breakpoint analysis

##### Breakpoint analysis of indicators

```{r Breakpoint analysis}

# breapoint function
bp_analysis <- function(x){
  mod <-  lm(values ~ Year, data = x)
  o <- tryCatch(segmented::segmented(mod, seg.Z = ~Year, psi = c(2005)),  # need to estimate bp
                error = function(cond){cond})
}


# Breakpoint by stat area
indicator_breakpoint <- allIndex %>%
  pivot_longer(cols = c(sur_temp, bot_temp, sur_sal, bot_sal, MCCPC1, predators), 
               names_to = "Indicator", values_to = "values") %>% 
  nest(data = c(-stat_area, -Indicator)) %>% 
  mutate(seg = purrr::map(data, ~bp_analysis(.x)),
         bp = purrr::map(seg, ~data.frame(.x$psi)))

# get fitted values and plot over data
bp_plots <- list()
for(i in 1:length(indicator_breakpoint$data)){
  
  name <- paste0(indicator_breakpoint$stat_area[[i]], "_", indicator_breakpoint$Indicator[[i]])
  
    # get the fitted data
  fitted_df <- fitted(indicator_breakpoint$seg[[i]])
  
  if(is.null(fitted_df)){
    
    "check error log"
    
  } else {
      
    seg_model <- data.frame(Year = indicator_breakpoint$data[[i]]$Year, values = fitted_df)
  
  # plot the fitted model
  
    bp_plots[[name]] <- indicator_breakpoint$data[[i]] %>% 
      ggplot() + geom_line(aes(Year, values)) +
      geom_line(data = seg_model, aes(x = Year, y = values), col = "dark red")
  }
}

set.seed(1)
# extract the breakpoints
break_years <- indicator_breakpoint %>% 
  unnest(bp) %>% 
  select(stat_area, Indicator, Est.) %>% 
  mutate(Indicator = factor(Indicator, levels = c("MCCPC1", "predators", "sur_sal", "sur_temp", "bot_sal", "bot_temp")))

# plot break points
ggplot(break_years) +
  geom_point(aes(Est., Indicator, color = stat_area, shape = stat_area), size = 3) +
  scale_color_grey(name = "Stat area") +
  scale_shape(name = "Stat area") +
  labs(x = "Estimated breakpoint")

```


##### Brakpoint analysis of PC1 and PC2

```{r breakpoint_pc1}
set.seed(8)
# Breakpoint by stat area
pc1_breakpoint <- index_pca %>%
  select(stat_area, Year, PC1, PC2)  %>%
  pivot_longer(cols = c(PC1, PC2), 
               names_to = "Indicator", values_to = "values") %>% 
  nest(data = c(-stat_area, -Indicator))%>% 
  mutate(seg = purrr::map(data, ~bp_analysis(.x)),
         bp = purrr::map(seg, ~data.frame(.x$psi))) %>% 
  unnest(bp) %>% 
  select(stat_area, Indicator, Est., St.Err)

knitr::kable(pc1_breakpoint)

```




### Lobster Data {.tabset}


```{r biological_data}

ALSI <- read_csv(here::here("Biological_data/SettlementIndex.csv"))
ME_landings <- read_csv(here::here("Biological_data/ME_lob_landings_1950_2019.csv"))
ASFMCindicies <- read_csv(here::here("Biological_data/GOMGBK_indices.csv")) %>% 
  rename("lob_index" = Index, "name" = Survey)
GOMindex <- ASFMCindicies %>% 
  filter(name %in% c("MeFQ2", "MeMQ2"))
NEFSCindex <- ASFMCindicies %>% 
  filter(name %in% c("NefscFQ2", "NefscMQ2"))
sublegal <- readxl::read_excel(here::here("Biological_data/RawData.xlsx")) %>% 
  rename("Year" = year, "Month" = month, "stat_area" = `stat area`)

NEFSC_meIndex <- read_csv(here::here("Biological_data/nmfs_trawl_lobster_indices.csv")) %>% 
  rename("Year" = year, "stat_area" = `stratum id`)

```


#### ALSI index

Source: [American Lobster Settlement Index data portal](https://safis.accsp.org:8443/safis_prod/f?p=LSI:LOGIN)
Sites:

* Jonesport, Length: 2002-2018, stat area: 511
* Mt. Desert Island, Length: 2000-2018, stat area: 512
* Outer Penobscot Bay, Length: 2000-2018, stat area: 512
* Mid-coast, Length: 1989-2018, stat area: 513
* Casco Bay, Length: 2000-2018, stat area: 513
* York, Length: 2000-2018, stat area: 513

Methods:

* Sites grouped by NOAA stat area
* Time series cropped to shortest length
* Averaged by stat area

```{r ALSI_process}

statKey <- data.frame("Location" = c('Jonesport',
'Mt. Desert Island',
'Outer Pen Bay',
'Mid-coast',
'Casco Bay',
'York'), "stat_area" = c(511,512,512,513,513,513))

ALSI <- ALSI %>% 
  left_join(statKey, by = "Location") %>% 
  filter(!is.na(stat_area),
         Year >= 2000) %>% 
  group_by(stat_area, Year) %>% 
  summarise(lob_index = mean(Yoy_density), .groups = "drop") %>% 
  mutate(stat_area = as.factor(stat_area),
         name = "ALSI") %>% 
  na.omit()

ALSI_cors <- ALSI %>% 
  left_join(index_pca, by = c("Year", "stat_area")) %>% 
  group_by(stat_area, name) %>% 
  summarise(corPC1 = corrr::correlate(lob_index, PC1)[[2]],
            corPC2 = corrr::correlate(lob_index, PC2)[[2]],
            corPC3 = corrr::correlate(lob_index, PC3)[[2]])

ALSI_plot <- ALSI %>% 
  ggplot() +
  geom_line(aes(Year, lob_index, col = as.factor(stat_area))) +
  scale_color_discrete(name = "Stat area") +
  labs(y = "ALSI yoy density")

ALSI_plot

```

#### Sublegal index

##### Calculate stratified means

* Calculate catch per unit effort for each site for each year
* Multiply cpue by the depth strata area factor
* Group by stat area, sum the outputs 


```{r sublegal lobs}

strata_area_factor <- tibble("stat_area" = c(511,512,513),
                                 "1" = c(0.412162162, 0.409847936, 0.370152761),
                                 "2" = c(0.277027027, 0.28602462, 0.397179788),
                                 "3" = c(0.310810811, 0.304127444, 0.23266745)) %>% 
  pivot_longer(cols = c("1", "2", "3"), names_to = "depth stratum", values_to = "strata_scale") %>% 
  mutate(`depth stratum` = as.numeric(`depth stratum`))

sublegal_cpue <- sublegal %>% 
  group_by(`trip ID`, `trip date`, Year, Month, `site ID`, 
           `depth stratum`, stat_area,
           `soak nights`, depth, `depth unit`, 
           `latitude (dd)`, `longitude (dd)`, `effort ID`) %>% 
  mutate(lob_count = sum(`sample ID` != 0), 
            lob_effort = lob_count/`soak nights`) %>% 
  group_by(`trip ID`, `trip date`, Year, Month, 
           `site ID`, `depth stratum`, stat_area,
           `soak nights`, depth, `depth unit`, 
           `latitude (dd)`, `longitude (dd)`) %>% 
  summarise(cpue = sum(lob_effort)/sum(!is.na(unique(`effort ID`))), .groups = "drop") %>% 
  left_join(strata_area_factor, by = c("stat_area", "depth stratum")) %>% 
  mutate(stratified_cpue = cpue*strata_scale,
         stat_area = as.factor(stat_area)) %>% 
  group_by(stat_area, Year) %>% 
  summarise(lob_index = sum(stratified_cpue), .groups = "drop") %>% 
  mutate(name = "sublegal_cpue")

sub_leagal_cors <- sublegal_cpue %>% 
  left_join(index_pca, by = c("Year", "stat_area")) %>% 
  group_by(stat_area, name) %>% 
  summarise(corPC1 = corrr::correlate(lob_index, PC1)[[2]],
            corPC2 = corrr::correlate(lob_index, PC2)[[2]],
            corPC3 = corrr::correlate(lob_index, PC3)[[2]])
            
sublegal_plot <- sublegal_cpue %>% 
  ggplot() +
  geom_line(aes(Year, lob_index, col = as.factor(stat_area))) +
  scale_color_discrete(name = "Stat area") +
  labs(y = "Sublegal lobster cpue")

sublegal_plot

```

#### ME yearly landings

Yearly Maine lobster landings in pounds from 1950-2020.

```{r yearly_landingd}

ME_landings_cors <- ME_landings %>% 
  left_join(index_pca, by = c("Year")) %>% 
  group_by(stat_area) %>% 
  summarise(corPC1 = corrr::correlate(Pounds, PC1)[[2]],
            corPC2 = corrr::correlate(Pounds, PC2)[[2]],
            corPC3 = corrr::correlate(Pounds, PC3)[[2]]) 

ME_pounds <- ME_landings %>% 
  mutate(name = "ME_landings") %>% 
  select(Year, "lob_index" = Pounds, name) 

ME_pounds %>% 
  ggplot() +
  geom_line(aes(Year, lob_index)) +
  labs(y = "Maine lobster landings (pounds)")

```


#### ME trawl index

NOTE: Calculate this index using the data in Res_data

ASFMC lobster abundance index based on the Maine trawl survey. Time spans 2003-2018 and indices are split into seasons and sex.

```{r GOMindex}

GOM_cors <- GOMindex %>% 
  left_join(index_pca, by = "Year") %>% 
  group_by(stat_area, name) %>% 
  summarise(corPC1 = corrr::correlate(lob_index, PC1)[[2]],
            corPC2 = corrr::correlate(lob_index, PC2)[[2]],
            corPC3 = corrr::correlate(lob_index, PC3)[[2]], .groups = "drop")

GOMindex %>% 
  ggplot() +
  geom_line(aes(Year, lob_index)) +
  facet_wrap(~name) +
  labs(y = "ME Trawl lob abundance Index")

```


#### Nefsc index

ASFMC lobster abundance index based on the NE fisheries trawl survey. Time spans 1978-2018 and indices are split into seasons and sex.

```{r Nefscindex}

NEFSC_cors <- NEFSCindex %>% 
  left_join(index_pca, by = "Year") %>% 
  group_by(stat_area, name) %>% 
  summarise(corPC1 = corrr::correlate(lob_index, PC1)[[2]],
            corPC2 = corrr::correlate(lob_index, PC2)[[2]],
            corPC3 = corrr::correlate(lob_index, PC3)[[2]], .groups = "drop")

NEFSCindex %>% 
  ggplot() +
  geom_line(aes(Year, lob_index)) +
  facet_wrap(~name) +
  labs(y = "Nefsc trawl lob abundance index")

```


### Biological data analysis{.tabset}


```{r analysis functions}

xyPlot <- function(x){
  x %>% 
    left_join(index_pca) %>% 
    na.omit() %>% 
    ggplot() +
    geom_point(aes(PC1, lob_index, color = stat_area)) + 
    geom_smooth(aes(PC1, lob_index, color = stat_area), method = "lm", se = FALSE) +
    facet_wrap(~name)
}

aicModel <- function(x){
  x %>% 
    left_join(index_pca) %>% 
    na.omit() %>% 
    select(stat_area, lob_index, PC1, PC2, PC3, name) %>% 
    group_by(stat_area, name) %>% 
    nest() %>% 
    mutate(aic = purrr::map(data, ~MASS::stepAIC(object = lm(lob_index ~ PC1 + PC2, data = .x), direction = "both", trace = 0)),
           stp = purrr::map(aic, broom::glance),
           index = purrr::map(aic, ~as.character(.x$call$formula)),
           model = paste(index[[1]][[2]], index[[1]][[1]], index[[1]][[3]])) %>% 
    select(stat_area, stp, model, name) %>% 
    unnest(c(stp, model))
}


##################################################

# break out trawl survey by stat area
# see what groups together to see if there is a distinction in the life history patterns
# Look at coefficients to see if PC1 is always the biggest


```

#### ALSI index

Correlation table

```{r ALSI corrs}
ALSI_cors %>% 
  na.omit() %>% 
  knitr::kable()
```

Scatter plot

```{r xyALSI plot}

xyPlot(ALSI)

```

AIC lm model selection table

```{r aicALSI}
aicSel <- aicModel(ALSI)

knitr::kable(aicSel)
```

#### Subleagal index

Correlation table

```{r sublegal corrs}

sub_leagal_cors %>%  
  na.omit() %>% 
  knitr::kable()
```

Scatter plot

```{r xysublegal}
xyPlot(sublegal_cpue)
```

AIC lm model selection table

```{r aicsublegal}

aicSel <- aicModel(sublegal_cpue)

knitr::kable(aicSel)
```


#### ME yearly landings

Correlation table

```{r landings corrs}

ME_landings_cors %>%  
  na.omit() %>% 
  knitr::kable()
```

Scatter plot

```{r}
xyPlot(ME_pounds)
```


AIC lm model selection table

```{r}
aicSel <- aicModel(ME_pounds)

knitr::kable(aicSel)
```


#### ME Trawl index

Correlation table

```{r MEtrawl corrs}
GOM_cors %>% 
  filter(name %in% c("MeFQ2", "MeFQ4", "MeMQ2", "MeMQ4")) %>% 
  na.omit() %>% 
  knitr::kable()
```

Scatter plot

```{r}
xyPlot(GOMindex)
```


AIC lm model selection table

```{r}
aicSel <- aicModel(GOMindex)

knitr::kable(aicSel)
```


#### NEFSC trawl index

Correlation table

```{r NefscTrawl corrs}

NEFSC_cors %>% 
  filter(name %in% c("NefscFQ2", "NefscFQ4", "NefscMQ2", "NefscMQ4")) %>% 
  na.omit() %>% 
  knitr::kable()
```

Scatter plot

```{r}

xyPlot(NEFSCindex)
```


AIC lm model selection table

```{r}

aicSel <- aicModel(NEFSCindex)

knitr::kable(aicSel)
```




#### Cluster Analysis


```{r cluster Analysis}

GOMindex_ca <- GOMindex %>% 
  filter(Season == 2) %>% 
  select(Year, lob_index, name)

NEFSCindex_ca <- NEFSCindex %>% 
  filter(Season == 2) %>% 
  select(Year, lob_index, name)

lobData <- bind_rows(ALSI, sublegal_cpue, ME_pounds, GOMindex_ca, NEFSCindex_ca) %>% 
  pivot_wider(names_from = c(name, stat_area),
              values_from = lob_index) %>% 
  na.omit() %>% 
  column_to_rownames("Year") 

# standardize variables
lobData <- scale(lobData) %>% 
  data.frame()

lobData_t <- data.table::transpose(lobData)

# get row and colnames in order
colnames(lobData_t) <- rownames(lobData)
rownames(lobData_t) <- colnames(lobData)



# determine number of clusters
wss <- (nrow(lobData)-1)*sum(apply(lobData,2,var)) # get sum of squares

for (i in 2:12) wss[i] <- sum(kmeans(lobData,
   centers=i)$withinss)

# look for break in plot like a scree plot
plot(1:12, wss, type="b", xlab="Number of Clusters",
  ylab="Within groups sum of squares")

fpc::pamk(lobData)

# K-Means Cluster Analysis
fit <- kmeans(lobData, 2) # 3 cluster solution
# get cluster means
aggregate(lobData,by=list(fit$cluster),FUN=mean)
# append cluster assignment
lobData_cluster <- data.frame(lobData, fit$cluster)

# Cluster Plot against 1st 2 principal components

# vary parameters for most readable graph
cluster::clusplot(lobData, fit$cluster, color=TRUE, shade=TRUE,
   labels=2, lines=0)

# Centroid Plot against 1st 2 discriminant functions
fpc::plotcluster(lobData, fit$cluster)

```


